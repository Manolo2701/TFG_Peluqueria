<div class="calendario-container">
  <!-- Header idéntico al catálogo -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-main">
        <button mat-icon-button routerLink="/dashboard" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="header-text">
          <h1>Calendario General</h1>
          <p>Vista completa de todas las reservas del sistema</p>
        </div>
      </div>
      <div class="header-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="recargar()"
          [disabled]="loading"
          class="refresh-btn"
        >
          <mat-icon>refresh</mat-icon>
          Actualizar
        </button>
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="content-card">
    <!-- Filtros -->
    <div class="filters-card">
      <div class="filters-container">
        <!-- Filtro por fecha -->
        <mat-form-field appearance="outline">
          <mat-label>Seleccionar fecha</mat-label>
          <input
            matInput
            [matDatepicker]="picker"
            [(ngModel)]="fechaSeleccionada"
            (dateChange)="onFechaChange()"
            [disabled]="mostrandoTodasLasReservas"
          />
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <!-- Botón Ver Todas/Volver a Fecha -->
        <button
          *ngIf="!mostrandoTodasLasReservas"
          mat-stroked-button
          color="primary"
          (click)="verTodasLasReservas()"
          class="view-all-btn"
        >
          <mat-icon>view_list</mat-icon>
          Ver Todas las Reservas
        </button>

        <button
          *ngIf="mostrandoTodasLasReservas"
          mat-stroked-button
          color="accent"
          (click)="onFechaChange()"
          class="view-all-btn"
        >
          <mat-icon>calendar_today</mat-icon>
          Volver a Filtro por Fecha
        </button>

        <!-- Estadísticas -->
        <div class="stats">
          <span class="stat-item">
            <strong>{{ reservasFiltradas.length }}</strong>
            {{ mostrandoTodasLasReservas ? 'reservas totales' : 'reservas hoy' }}
          </span>
          <span class="stat-item">
            <strong>{{ contarReservasConfirmadas() }}</strong> confirmadas
          </span>
          <span class="stat-item">
            <strong>{{ contarReservasPendientes() }}</strong> pendientes
          </span>
        </div>
      </div>

      <div class="estado-filters-container">
        <button
          mat-stroked-button
          [class.active]="filtroEstado === 'todas'"
          (click)="onFiltroEstadoChange('todas')"
          class="estado-filtro-btn"
        >
          <mat-icon>list</mat-icon>
          Todas ({{ contarReservasPorEstado('todas') }})
        </button>

        <button
          mat-stroked-button
          [class.active]="filtroEstado === 'pendientes'"
          (click)="onFiltroEstadoChange('pendientes')"
          class="estado-filtro-btn"
        >
          <mat-icon>schedule</mat-icon>
          Pendientes ({{ contarReservasPorEstado('pendientes') }})
        </button>

        <button
          mat-stroked-button
          [class.active]="filtroEstado === 'confirmadas'"
          (click)="onFiltroEstadoChange('confirmadas')"
          class="estado-filtro-btn"
        >
          <mat-icon>check_circle</mat-icon>
          Confirmadas ({{ contarReservasPorEstado('confirmadas') }})
        </button>

        <button
          mat-stroked-button
          [class.active]="filtroEstado === 'completadas'"
          (click)="onFiltroEstadoChange('completadas')"
          class="estado-filtro-btn"
        >
          <mat-icon>done_all</mat-icon>
          Completadas ({{ contarReservasPorEstado('completadas') }})
        </button>

        <button
          mat-stroked-button
          [class.active]="filtroEstado === 'canceladas'"
          (click)="onFiltroEstadoChange('canceladas')"
          class="estado-filtro-btn"
        >
          <mat-icon>cancel</mat-icon>
          Canceladas ({{ contarReservasPorEstado('canceladas') }})
        </button>

        <button
          mat-stroked-button
          [class.active]="filtroEstado === 'rechazadas'"
          (click)="onFiltroEstadoChange('rechazadas')"
          class="estado-filtro-btn"
        >
          <mat-icon>block</mat-icon>
          Rechazadas ({{ contarReservasPorEstado('rechazadas') }})
        </button>
      </div>
    </div>

    <!-- Estados de carga y error -->
    <div *ngIf="loading" class="loading-state">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando calendario...</p>
    </div>

    <div *ngIf="error && !loading" class="error-state">
      <mat-icon color="warn">error_outline</mat-icon>
      <h3>Error al cargar el calendario</h3>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="recargar()">
        <mat-icon>refresh</mat-icon>
        Reintentar
      </button>
    </div>

    <!-- Lista de Reservas -->
    <div *ngIf="!loading && !error">
      <div
        *ngIf="reservasFiltradas.length === 0 && !mostrandoTodasLasReservas"
        class="no-data-card"
      >
        <mat-icon>event_busy</mat-icon>
        <h3>No hay reservas para esta fecha</h3>
        <p>No se encontraron reservas para el {{ fechaSeleccionada | date : 'fullDate' }}</p>
      </div>

      <div *ngIf="reservasFiltradas.length === 0 && mostrandoTodasLasReservas" class="no-data-card">
        <mat-icon>event_busy</mat-icon>
        <h3>No hay reservas en el sistema</h3>
        <p>No se encontraron reservas registradas</p>
      </div>

      <div *ngIf="reservasFiltradas.length > 0" class="reservas-container">
        <mat-card
          *ngFor="let reserva of reservasFiltradas"
          class="reserva-card"
          [class]="'reserva-' + reserva.estado"
        >
          <div class="reserva-header">
            <div class="reserva-time">
              <mat-icon>schedule</mat-icon>
              <span class="time">{{ formatTime(reserva.hora_inicio) }}</span>
              <span class="duration" *ngIf="reserva.duracion">({{ reserva.duracion }} min)</span>
            </div>
            <div class="reserva-status" [class]="'status-' + reserva.estado">
              <mat-icon>{{
                reserva.estado === 'pendiente'
                  ? 'schedule'
                  : reserva.estado === 'confirmada'
                  ? 'check_circle'
                  : reserva.estado === 'completada'
                  ? 'done_all'
                  : reserva.estado === 'cancelada'
                  ? 'cancel'
                  : reserva.estado === 'rechazada'
                  ? 'block'
                  : 'help'
              }}</mat-icon>
              {{ reserva.estado | titlecase }}
            </div>
          </div>

          <div class="reserva-content">
            <div class="reserva-info">
              <div class="info-item">
                <mat-icon>person</mat-icon>
                <span
                  >{{ reserva.cliente_nombre || 'Cliente' }}
                  {{ reserva.cliente_apellidos || '' }}</span
                >
              </div>
              <div class="info-item">
                <mat-icon>spa</mat-icon>
                <span>{{ reserva.servicio_nombre || 'Servicio' }}</span>
              </div>
              <div class="info-item">
                <mat-icon>badge</mat-icon>
                <span>{{
                  reserva.trabajador_nombre && reserva.trabajador_apellidos
                    ? reserva.trabajador_nombre + ' ' + reserva.trabajador_apellidos
                    : reserva.trabajador_id
                    ? 'Trabajador #' + reserva.trabajador_id
                    : 'Sin asignar'
                }}</span>
              </div>
              <div class="info-item" *ngIf="reserva.precio">
                <mat-icon>euro</mat-icon>
                <span>{{ formatCurrency(reserva.precio) }}</span>
              </div>

              <!-- Motivo de cancelación/rechazo -->
              <div
                class="info-item motivo-item"
                *ngIf="
                  (reserva.estado === 'cancelada' || reserva.estado === 'rechazada') &&
                  reserva.motivo_cancelacion
                "
              >
                <mat-icon>{{ reserva.estado === 'cancelada' ? 'chat' : 'block' }}</mat-icon>
                <div class="motivo-content">
                  <span class="motivo-label">
                    {{ reserva.estado === 'cancelada' ? 'Motivo:' : 'Motivo del rechazo:' }}
                  </span>
                  <span class="motivo-text">{{ reserva.motivo_cancelacion }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="reserva-actions">
            <button mat-button color="primary" (click)="verDetalles(reserva)">
              <mat-icon>visibility</mat-icon>
              Ver Detalles
            </button>
          </div>
        </mat-card>
      </div>
    </div>
  </div>

  <!-- Footer idéntico al catálogo -->
  <footer class="calendario-footer">
    <div class="footer-content">
      <p>&copy; 2025 Peluquería y Estética Selene. Todos los derechos reservados.</p>
    </div>
  </footer>
</div>
