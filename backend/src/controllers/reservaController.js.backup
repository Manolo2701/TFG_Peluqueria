const Reserva = require('../models/Reserva');
const Servicio = require('../models/Servicio');
const Trabajador = require('../models/Trabajador');
const CalendarioUtils = require('../utils/calendarioUtils');

// Crear nueva reserva - SISTEMA H√çBRIDO MEJORADO
exports.crearReserva = async (req, res) => {
  try {
    const { servicio_id, fecha_reserva, hora_inicio, notas, trabajador_id } = req.body;
    const cliente_id = req.usuario.id;

    console.log('üéØ INICIANDO CREACI√ìN DE RESERVA - FLUJO COMPLETO');
    console.log('Datos recibidos:', req.body);

    // 1. Obtener informaci√≥n del servicio
    const servicio = await Servicio.buscarPorId(servicio_id);
    if (!servicio) {
      return res.status(404).json({ error: 'Servicio no encontrado' });
    }

    console.log('üîç Servicio:', servicio.nombre, '- Categor√≠a:', servicio.categoria);

    // 2. SI se proporciona trabajador_id, VERIFICAR DISPONIBILIDAD REAL
    let trabajadorValido = null;
    if (trabajador_id) {
      console.log('‚úÖ Cliente eligi√≥ trabajador espec√≠fico:', trabajador_id);

      const trabajador = await Trabajador.obtenerPerfil(trabajador_id);
      if (!trabajador) {
        return res.status(404).json({ error: 'Trabajador no encontrado' });
      }

      // Verificar especialidad
      const puedeRealizar = CalendarioUtils.puedeRealizarServicio(trabajador, servicio);
      if (!puedeRealizar) {
        return res.status(400).json({
          error: `El trabajador no est√° especializado en servicios de ${servicio.categoria}`
        });
      }

      // ‚úÖ VERIFICAR DISPONIBILIDAD REAL (horario laboral + sin conflictos)
      const disponible = await Reserva.verificarDisponibilidad(
        trabajador_id,
        fecha_reserva,
        hora_inicio,
        servicio.duracion
      );

      if (!disponible) {
        return res.status(400).json({
          error: 'El trabajador seleccionado no tiene disponibilidad en ese horario'
        });
      }

      trabajadorValido = trabajador_id;
      console.log('üéØ Trabajador validado y disponible');
    } else {
      // 3. SI NO se proporciona trabajador_id, BUSCAR AUTOM√ÅTICAMENTE
      console.log('üîç Buscando trabajador disponible autom√°ticamente...');

      const todosTrabajadores = await Trabajador.listarTodos();
      const trabajadoresCapaces = CalendarioUtils.filtrarTrabajadoresPorCategoria(
        todosTrabajadores,
        servicio.categoria
      );

      console.log(`üë• Trabajadores capaces: ${trabajadoresCapaces.length}`);

      // Buscar el primer trabajador disponible
      for (const trabajador of trabajadoresCapaces) {
        const disponible = await Reserva.verificarDisponibilidad(
          trabajador.id,
          fecha_reserva,
          hora_inicio,
          servicio.duracion
        );

        if (disponible) {
          trabajadorValido = trabajador.id;
          console.log(`‚úÖ Trabajador autom√°ticamente asignado: ${trabajador.nombre}`);
          break;
        }
      }

      if (!trabajadorValido) {
        return res.status(400).json({
          error: 'No hay trabajadores disponibles para este horario. Por favor, elige otra fecha/hora.'
        });
      }
    }

    // 4. CREAR LA RESERVA
    const reservaData = {
      cliente_id,
      servicio_id,
      trabajador_id: trabajadorValido,
      fecha_reserva,
      hora_inicio,
      duracion: servicio.duracion,
      estado: 'confirmada', // Directamente confirmada cuando el cliente elige trabajador
      notas: notas || `Reserva para ${servicio.nombre}`
    };

    console.log('üíæ Guardando reserva...');
    const reservaId = await Reserva.crear(reservaData);
    console.log('‚úÖ Reserva creada con ID:', reservaId);

    const nuevaReserva = await Reserva.buscarPorId(reservaId);

    res.status(201).json({
      mensaje: 'Reserva creada exitosamente',
      reserva: nuevaReserva
    });

  } catch (error) {
    console.error('‚ùå ERROR en crearReserva:', error.message);
    res.status(500).json({ error: error.message });
  }
};

// ‚úÖ NUEVO ENDPOINT: Obtener trabajadores disponibles para un servicio espec√≠fico
exports.obtenerTrabajadoresParaServicio = async (req, res) => {
  try {
    const { servicio_id } = req.params;

    console.log('üîç Buscando trabajadores para servicio ID:', servicio_id);

    // Obtener informaci√≥n del servicio
    const servicio = await Servicio.buscarPorId(servicio_id);
    if (!servicio) {
      return res.status(404).json({ error: 'Servicio no encontrado' });
    }

    console.log('üìã Servicio encontrado:', servicio.nombre, '- Categor√≠a:', servicio.categoria);

    // Obtener todos los trabajadores activos
    const todosTrabajadores = await Trabajador.listarTodos();
    console.log('üë• Total de trabajadores:', todosTrabajadores.length);

    // Filtrar trabajadores por categor√≠a del servicio - CORREGIDO
    const trabajadoresFiltrados = todosTrabajadores.filter(trabajador => {
      console.log(`üîç Validando trabajador: ${trabajador.nombre}`);
      // ‚úÖ Asegurarnos de que el servicio se pase correctamente
      const puedeRealizar = CalendarioUtils.puedeRealizarServicio(trabajador, servicio);
      console.log(`   Resultado para ${trabajador.nombre}: ${puedeRealizar}`);
      return puedeRealizar;
    });

    console.log(`‚úÖ Trabajadores especializados en ${servicio.categoria}:`, trabajadoresFiltrados.length);

    res.json({
      servicio: {
        id: servicio.id,
        nombre: servicio.nombre,
        categoria: servicio.categoria,
        duracion: servicio.duracion
      },
      trabajadores: trabajadoresFiltrados.map(t => ({
        id: t.id,
        nombre: t.nombre,
        apellidos: t.apellidos,
        especialidades: t.especialidades,
        descripcion: t.descripcion,
        experiencia: t.experiencia
      })),
      total: trabajadoresFiltrados.length
    });
  } catch (error) {
    console.error('‚ùå Error en obtenerTrabajadoresParaServicio:', error.message);
    res.status(500).json({ error: error.message });
  }
};

// Obtener todas las reservas (admin)
exports.obtenerReservas = async (req, res) => {
  try {
    if (req.usuario.rol !== 'administrador') {
      return res.status(403).json({ error: 'No tienes permisos para esta acci√≥n' });
    }

    const reservas = await Reserva.listarTodas();
    res.json({
      total: reservas.length,
      reservas
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

// Obtener reservas del cliente actual
exports.obtenerMisReservas = async (req, res) => {
  try {
    const cliente_id = req.usuario.id;
    const reservas = await Reserva.buscarPorCliente(cliente_id);

    res.json({
      total: reservas.length,
      reservas
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

// Obtener reserva por ID
exports.obtenerReserva = async (req, res) => {
  try {
    const { id } = req.params;
    const reserva = await Reserva.buscarPorId(id);

    if (!reserva) {
      return res.status(404).json({ error: 'Reserva no encontrada' });
    }

    // Verificar permisos: cliente ve solo sus reservas, admin ve todas
    if (req.usuario.rol !== 'administrador' && reserva.cliente_id !== req.usuario.id) {
      return res.status(403).json({ error: 'No tienes permisos para ver esta reserva' });
    }

    res.json(reserva);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }

  // Obtener trabajadores disponibles para un servicio, fecha y hora espec√≠ficos
  exports.obtenerTrabajadoresDisponibles = async (req, res) => {
    try {
      const { servicio_id, fecha, hora } = req.query;

      if (!servicio_id || !fecha || !hora) {
        return res.status(400).json({
          error: 'servicio_id, fecha y hora son requeridos'
        });
      }

      console.log(`üîç Buscando trabajadores disponibles para servicio ${servicio_id} en ${fecha} a las ${hora}`);

      // 1. Obtener servicio
      const servicio = await Servicio.buscarPorId(servicio_id);
      if (!servicio) {
        return res.status(404).json({ error: 'Servicio no encontrado' });
      }

      // 2. Obtener trabajadores de la categor√≠a
      const todosTrabajadores = await Trabajador.listarTodos();
      const trabajadoresCapaces = CalendarioUtils.filtrarTrabajadoresPorCategoria(
        todosTrabajadores,
        servicio.categoria
      );

      console.log(`üë• Trabajadores capaces de ${servicio.categoria}: ${trabajadoresCapaces.length}`);

      // 3. Verificar disponibilidad de cada trabajador
      const trabajadoresDisponibles = [];

      for (const trabajador of trabajadoresCapaces) {
        const disponible = await Reserva.verificarDisponibilidad(
          trabajador.id,
          fecha,
          hora,
          servicio.duracion
        );

        if (disponible) {
          trabajadoresDisponibles.push({
            id: trabajador.id,
            nombre: trabajador.nombre,
            apellidos: trabajador.apellidos,
            especialidades: trabajador.especialidades,
            descripcion: trabajador.descripcion,
            disponible: true
          });
        }
      }

      console.log(`‚úÖ Trabajadores disponibles: ${trabajadoresDisponibles.length}`);

      res.json({
        servicio: {
          id: servicio.id,
          nombre: servicio.nombre,
          categoria: servicio.categoria,
          duracion: servicio.duracion,
          precio: servicio.precio
        },
        fecha,
        hora,
        trabajadores: trabajadoresDisponibles,
        total: trabajadoresDisponibles.length
      });

    } catch (error) {
      console.error('‚ùå Error en obtenerTrabajadoresDisponibles:', error);
      res.status(500).json({ error: error.message });
    }
  };
};