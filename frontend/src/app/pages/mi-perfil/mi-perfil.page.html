<div class="mi-perfil-container">
  <!-- Header simplificado sin bot칩n de recargar -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-main">
        <button mat-icon-button routerLink="/dashboard" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="header-text">
          <h1>Mi Perfil</h1>
          <p>Administra tu informaci칩n personal</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando datos del perfil...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-state">
    <mat-icon color="warn">error_outline</mat-icon>
    <h3>Error al cargar el perfil</h3>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="cargarPerfil()">
      <mat-icon>refresh</mat-icon>
      Reintentar
    </button>
  </div>

  <!-- Content -->
  <div *ngIf="!loading && !error" class="content">
    <!-- Estad칤sticas -->
    <section class="section" *ngIf="perfilData">
      <h2>游늵 Mis Datos</h2>
      <div class="stats-cards">
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-value nombre">{{ primerNombre }}</div>
              <div class="stat-label">Nombre</div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-value email">{{ perfilData.email }}</div>
              <div class="stat-label">Email</div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Solo mostrar rol si no es cliente -->
        <mat-card class="stat-card" *ngIf="perfilData.rol !== 'cliente'">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-value rol">
                <span class="role-badge" [class]="perfilData.rol">{{ perfilData.rol }}</span>
              </div>
              <div class="stat-label">Rol</div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Tarjeta adicional para equilibrar el dise침o si es cliente -->
        <mat-card class="stat-card" *ngIf="perfilData.rol === 'cliente'">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-value fecha">{{ formatearFecha(perfilData.fecha_registro) }}</div>
              <div class="stat-label">Fecha de registro</div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </section>

    <!-- Formulario de Perfil -->
    <section class="section">
      <h2>游닇 Editar Informaci칩n Personal</h2>
      <form [formGroup]="perfilForm" (ngSubmit)="onSubmit()" class="perfil-form">
        <!-- Informaci칩n Personal -->
        <mat-card class="section-card">
          <mat-card-header>
            <mat-icon mat-card-avatar>person</mat-icon>
            <mat-card-title>Informaci칩n Personal</mat-card-title>
            <mat-card-subtitle>Datos b치sicos de tu cuenta</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Nombre *</mat-label>
                <input
                  matInput
                  formControlName="nombre"
                  placeholder="Tu nombre"
                  [class.is-invalid]="nombreControl?.invalid && nombreControl?.touched"
                />
                <mat-error *ngIf="nombreControl?.hasError('required')">
                  El nombre es obligatorio
                </mat-error>
                <mat-error *ngIf="nombreControl?.hasError('minlength')">
                  El nombre debe tener al menos 2 caracteres
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Apellidos *</mat-label>
                <input
                  matInput
                  formControlName="apellidos"
                  placeholder="Tus apellidos"
                  [class.is-invalid]="apellidosControl?.invalid && apellidosControl?.touched"
                />
                <mat-error *ngIf="apellidosControl?.hasError('required')">
                  Los apellidos son obligatorios
                </mat-error>
                <mat-error *ngIf="apellidosControl?.hasError('minlength')">
                  Los apellidos deben tener al menos 2 caracteres
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Email *</mat-label>
                <input
                  matInput
                  formControlName="email"
                  type="email"
                  placeholder="tu@email.com"
                  [class.is-invalid]="emailControl?.invalid && emailControl?.touched"
                />
                <mat-error *ngIf="emailControl?.hasError('required')">
                  El email es obligatorio
                </mat-error>
                <mat-error *ngIf="emailControl?.hasError('email')">
                  Introduce un email v치lido
                </mat-error>
                <mat-hint>Ejemplo: usuario@dominio.com</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Tel칠fono</mat-label>
                <input
                  matInput
                  formControlName="telefono"
                  placeholder="N칰mero de tel칠fono"
                  [class.is-invalid]="telefonoControl?.invalid && telefonoControl?.touched"
                />
                <mat-hint>Formatos: 612 34 56 78, 612 345 678, 612345678</mat-hint>
                <mat-error *ngIf="telefonoControl?.hasError('phoneInvalidFormat')">
                  Formato inv치lido. Solo se permiten n칰meros, espacios y guiones
                </mat-error>
                <mat-error *ngIf="telefonoControl?.hasError('phoneInvalidLength')">
                  El n칰mero debe tener entre 9 y 12 d칤gitos
                </mat-error>
                <mat-error *ngIf="telefonoControl?.hasError('phoneInvalid')">
                  N칰mero inv치lido. Formatos aceptados: XXX XX XX XX, XXX XXX XXX o XXXXXXXXX
                </mat-error>
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="form-field-full">
              <mat-label>Direcci칩n</mat-label>
              <textarea
                matInput
                formControlName="direccion"
                rows="2"
                placeholder="Tu direcci칩n completa"
              ></textarea>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- Cambio de Contrase침a -->
        <mat-card class="section-card">
          <mat-card-header>
            <mat-icon mat-card-avatar>lock</mat-icon>
            <mat-card-title>Seguridad</mat-card-title>
            <mat-card-subtitle>Cambia tu contrase침a si lo deseas</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="password-toggle">
              <button type="button" mat-button (click)="toggleCambioPassword()" class="toggle-btn">
                <mat-icon>{{ mostrarCambioPassword ? 'remove' : 'add' }}</mat-icon>
                {{ mostrarCambioPassword ? 'Ocultar cambio de contrase침a' : 'Cambiar contrase침a' }}
              </button>
            </div>

            <div *ngIf="mostrarCambioPassword" class="password-fields">
              <mat-form-field appearance="outline" class="form-field-full">
                <mat-label>Contrase침a actual *</mat-label>
                <input
                  matInput
                  formControlName="currentPassword"
                  type="password"
                  placeholder="Tu contrase침a actual"
                  [class.is-invalid]="
                    currentPasswordControl?.invalid && currentPasswordControl?.touched
                  "
                />
                <mat-error *ngIf="currentPasswordControl?.hasError('required')">
                  Para cambiar la contrase침a, debes introducir la actual
                </mat-error>
              </mat-form-field>

              <div class="form-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Nueva contrase침a</mat-label>
                  <input
                    matInput
                    formControlName="newPassword"
                    type="password"
                    placeholder="Nueva contrase침a"
                    [class.is-invalid]="newPasswordControl?.invalid && newPasswordControl?.touched"
                  />
                  <mat-hint>M칤nimo 6 caracteres, con al menos una letra y un n칰mero</mat-hint>
                  <mat-error *ngIf="newPasswordControl?.hasError('minlength')">
                    La contrase침a debe tener al menos 6 caracteres
                  </mat-error>
                  <mat-error *ngIf="newPasswordControl?.hasError('pattern')">
                    La contrase침a debe contener al menos una letra y un n칰mero
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Confirmar contrase침a</mat-label>
                  <input
                    matInput
                    formControlName="confirmPassword"
                    type="password"
                    placeholder="Repite la nueva contrase침a"
                    [class.is-invalid]="perfilForm.hasError('passwordMismatch')"
                  />
                  <mat-error *ngIf="perfilForm.hasError('passwordMismatch')">
                    Las contrase침as no coinciden
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Informaci칩n de la Cuenta - Solo para administradores y trabajadores -->
        <mat-card class="section-card" *ngIf="perfilData && perfilData.rol !== 'cliente'">
          <mat-card-header>
            <mat-icon mat-card-avatar>info</mat-icon>
            <mat-card-title>Informaci칩n de la Cuenta</mat-card-title>
            <mat-card-subtitle>Datos del sistema</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Rol:</span>
                <span class="info-value">
                  <span class="role-badge" [class]="perfilData.rol">{{ perfilData.rol }}</span>
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">Fecha de registro:</span>
                <span class="info-value">{{ formatearFecha(perfilData.fecha_registro) }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Acciones -->
        <div class="form-actions">
          <button
            type="button"
            mat-stroked-button
            (click)="volverAlDashboard()"
            class="cancel-btn"
            [disabled]="guardando"
          >
            Volver al Dashboard
          </button>
          <button
            type="submit"
            mat-raised-button
            color="primary"
            [disabled]="perfilForm.invalid || guardando"
            class="submit-btn"
          >
            <span *ngIf="!guardando">Guardar Cambios</span>
            <span *ngIf="guardando" class="saving-text">
              <mat-spinner diameter="20"></mat-spinner>
              Guardando...
            </span>
          </button>
        </div>
      </form>
    </section>
  </div>

  <!-- Footer -->
  <footer class="mi-perfil-footer">
    <div class="footer-content">
      <p>&copy; 2025 Peluquer칤a y Est칠tica Selene. Todos los derechos reservados.</p>
    </div>
  </footer>
</div>
