<div class="modal-overlay" (click)="close()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Recuperar Contraseña</h2>
      <button type="button" class="btn-close" (click)="close()">×</button>
    </div>

    <div class="modal-body">
      <!-- Paso 1: Ingresar Email -->
      <div *ngIf="step === 'email'">
        <p class="text-medium mb-4">
          Introduce tu email para verificar tu identidad mediante tu pregunta de seguridad.
        </p>

        <form [formGroup]="forgotPasswordForm">
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              formControlName="email"
              class="form-control"
              placeholder="tu@email.com"
              [class.is-invalid]="email.invalid && email.touched"
            />
            <div class="invalid-feedback" *ngIf="email.invalid && email.touched">
              <span *ngIf="email.errors?.['required']">El email es requerido</span>
              <span *ngIf="email.errors?.['email']">Por favor ingresa un email válido</span>
            </div>
          </div>

          <div *ngIf="errorMessage" class="alert alert-error mt-3">
            {{ errorMessage }}
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="close()">Cancelar</button>
            <button
              type="button"
              class="btn btn-primary"
              (click)="onSubmit()"
              [disabled]="email.invalid || loading"
            >
              {{ loading ? 'Verificando...' : 'Continuar' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Paso 2: Pregunta de Seguridad -->
      <div *ngIf="step === 'question'">
        <h3 class="mb-3">Pregunta de Seguridad</h3>
        <div class="security-question mb-4">
          <p class="text-medium">
            <strong>{{ preguntaSeguridad }}</strong>
          </p>
          <small class="text-muted">Esta pregunta fue configurada durante tu registro</small>
        </div>

        <form [formGroup]="forgotPasswordForm">
          <div class="form-group">
            <label for="respuestaSeguridad">Tu respuesta</label>
            <input
              type="text"
              id="respuestaSeguridad"
              formControlName="respuestaSeguridad"
              class="form-control"
              placeholder="Escribe tu respuesta"
              [class.is-invalid]="respuestaSeguridad.invalid && respuestaSeguridad.touched"
            />
            <div
              class="invalid-feedback"
              *ngIf="respuestaSeguridad.invalid && respuestaSeguridad.touched"
            >
              <span *ngIf="respuestaSeguridad.errors?.['required']">La respuesta es requerida</span>
            </div>
          </div>

          <div *ngIf="errorMessage" class="alert alert-error mt-3">
            {{ errorMessage }}
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="goBack()">← Volver</button>
            <button
              type="button"
              class="btn btn-primary"
              (click)="verifyAnswer()"
              [disabled]="respuestaSeguridad.invalid || loading"
            >
              {{ loading ? 'Verificando...' : 'Verificar respuesta' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Paso 3: Nueva Contraseña -->
      <div *ngIf="step === 'reset'">
        <h3 class="mb-3">Nueva Contraseña</h3>
        <p class="text-medium mb-4">
          ¡Respuesta correcta! Ahora puedes crear una nueva contraseña.
        </p>

        <form [formGroup]="newPasswordForm">
          <div class="form-group">
            <label for="nuevaPassword">Nueva Contraseña</label>
            <input
              type="password"
              id="nuevaPassword"
              formControlName="nuevaPassword"
              class="form-control"
              placeholder="Mínimo 6 caracteres con letra y número"
              [class.is-invalid]="nuevaPassword.invalid && nuevaPassword.touched"
            />
            <div class="invalid-feedback" *ngIf="nuevaPassword.invalid && nuevaPassword.touched">
              <span *ngIf="nuevaPassword.errors?.['required']">La contraseña es requerida</span>
              <span *ngIf="nuevaPassword.errors?.['minlength']">Mínimo 6 caracteres</span>
              <span *ngIf="nuevaPassword.errors?.['pattern']">Debe contener letra y número</span>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmarPassword">Confirmar Contraseña</label>
            <input
              type="password"
              id="confirmarPassword"
              formControlName="confirmarPassword"
              class="form-control"
              placeholder="Repite la contraseña"
              [class.is-invalid]="(confirmarPassword.invalid && confirmarPassword.touched) || newPasswordForm.errors?.['mismatch']"
            />
            <div class="invalid-feedback" *ngIf="newPasswordForm.errors?.['mismatch']">
              Las contraseñas no coinciden
            </div>
          </div>

          <div *ngIf="errorMessage" class="alert alert-error mt-3">
            {{ errorMessage }}
          </div>

          <div *ngIf="successMessage" class="alert alert-success mt-3">
            {{ successMessage }}
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="goBack()">← Volver</button>
            <button
              type="button"
              class="btn btn-primary"
              (click)="changePassword()"
              [disabled]="newPasswordForm.invalid || loading"
            >
              {{ loading ? 'Cambiando...' : 'Cambiar contraseña' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
